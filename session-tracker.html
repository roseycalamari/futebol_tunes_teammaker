<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Session - NiteRun</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#006dff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="NiteRun">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <style>
        .session-container {
            min-height: 100vh;
            background: var(--primary-color);
            padding: 3rem;
        }

        .session-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 3rem;
            padding: 1.5rem 0;
            position: relative;
        }

        .header-left {
            width: 120px;
            display: flex;
            justify-content: flex-start;
            align-items: center;
        }

        .header-center {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            justify-content: center;
        }

        .header-right {
            width: 120px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }

        .back-btn {
            background: var(--white);
            border: 3px solid transparent;
            color: var(--primary-color);
            padding: 0.8rem 1.2rem;
            border-radius: 0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'SK Glypher Trial', 'Poppins', sans-serif;
            font-size: 0.9rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-decoration: none;
        }

        .back-btn:hover {
            transform: scale(0.95);
            background: var(--white);
            color: var(--primary-color);
            border-color: transparent;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .session-title {
            color: var(--white);
            font-family: 'SK Glypher Trial', 'Poppins', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            text-align: center;
            margin: 0;
        }

        .session-status {
            background: var(--white);
            color: var(--primary-color);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #4CAF50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .teams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .team-card {
            background: var(--cream);
            border: 3px solid var(--primary-color);
            padding: 1.5rem;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .team-header {
            text-align: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--primary-color);
        }

        .team-name {
            color: var(--primary-color);
            font-family: 'SK Glypher Trial', 'Poppins', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .team-stats {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 1rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .team-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid #f0f0f0;
        }

        .control-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0;
            cursor: pointer;
            font-family: 'SK Glypher Trial', 'Poppins', sans-serif;
            font-size: 0.9rem;
            font-weight: 700;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .win-btn {
            background: #4CAF50;
            color: white;
        }

        .win-btn:hover {
            background: #45a049;
            transform: scale(1.05);
        }

        .loss-btn {
            background: #f44336;
            color: white;
        }

        .loss-btn:hover {
            background: #da190b;
            transform: scale(1.05);
        }

        .draw-btn {
            background: #ff9800;
            color: white;
        }

        .draw-btn:hover {
            background: #e68900;
            transform: scale(1.05);
        }

        .control-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .captain-only {
            position: relative;
        }

        .captain-only::after {
            content: "CAPTAIN ONLY";
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff6b35;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .team-players {
            margin-top: 1rem;
        }

        .player-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: rgba(0, 109, 255, 0.05);
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .player-info {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .player-number {
            width: 30px;
            height: 30px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            margin-right: 1rem;
        }

        .player-details {
            flex: 1;
        }

        .player-name {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.25rem;
        }

        .captain-badge {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .player-meta {
            font-size: 0.85rem;
            color: #666;
        }

        .remove-player-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .remove-player-btn:hover {
            background: #ff3742;
            transform: scale(1.05);
        }

        .session-actions {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 3rem;
        }

        .action-btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 0;
            cursor: pointer;
            font-family: 'SK Glypher Trial', 'Poppins', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .end-session-btn {
            background: var(--white);
            color: var(--primary-color);
            border: 3px solid var(--white);
        }

        .end-session-btn:hover {
            transform: scale(0.95);
            background: var(--white);
            color: var(--primary-color);
        }

        .emergency-delete-btn {
            background: #ff4757;
            color: white;
            border: 3px solid #ff4757;
        }

        .emergency-delete-btn:hover {
            transform: scale(0.95);
            background: #ff3742;
            border-color: #ff3742;
        }

        .mvp-selector {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .mvp-content {
            background: var(--cream);
            padding: 2.5rem;
            border-radius: 0;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border: 3px solid var(--primary-color);
        }

        .mvp-content h3 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 2rem;
            font-family: 'SK Glypher Trial', 'Poppins', sans-serif;
            font-size: 2rem;
            font-weight: 700;
        }

        .mvp-subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 2rem;
            font-size: 1rem;
        }

        .mvp-players {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }

        .mvp-player {
            padding: 1.5rem;
            border: 3px solid #e0e0e0;
            border-radius: 0;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            background: white;
            position: relative;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .mvp-player:hover {
            border-color: var(--primary-color);
            background: rgba(0, 109, 255, 0.05);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 109, 255, 0.2);
        }

        .mvp-player.selected {
            border-color: var(--primary-color);
            background: rgba(0, 109, 255, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 109, 255, 0.3);
        }

        .mvp-player.selected::before {
            content: "✓";
            position: absolute;
            top: -10px;
            right: -10px;
            background: var(--primary-color);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .mvp-player-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            font-family: 'SK Glypher Trial', 'Poppins', sans-serif;
        }

        .mvp-player-team {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .mvp-player-level {
            color: #888;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .mvp-actions {
            display: flex;
            gap: 1.5rem;
            justify-content: center;
        }

        .mvp-actions button {
            padding: 1rem 2rem;
            border: none;
            border-radius: 0;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'SK Glypher Trial', 'Poppins', sans-serif;
            font-size: 1rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
            border: 3px solid var(--primary-color);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
            transform: scale(0.95);
        }

        .btn-primary:disabled {
            background: #ccc;
            border-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: transparent;
            color: var(--primary-color);
            border: 3px solid var(--primary-color);
        }

        .btn-secondary:hover {
            background: var(--primary-color);
            color: white;
            transform: scale(0.95);
        }

        .loading {
            text-align: center;
            color: var(--white);
            font-size: 1.2rem;
            padding: 2rem;
        }

        .session-info {
            background: var(--cream);
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 3px solid var(--primary-color);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .session-info h3 {
            color: var(--primary-color);
            margin: 0 0 1rem 0;
            font-family: 'SK Glypher Trial', 'Poppins', sans-serif;
            font-size: 1.5rem;
        }

        .session-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .session-stat {
            text-align: center;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            border: 2px solid #f0f0f0;
        }

        .session-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            display: block;
        }

        .session-stat-label {
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        @media (max-width: 768px) {
            .session-container {
                padding: 1.5rem;
            }

            .session-title {
                font-size: 2rem;
            }

            .teams-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .team-stats {
                gap: 1rem;
            }

            .session-actions {
                flex-direction: column;
                gap: 1rem;
            }

            .action-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="session-container">
        <!-- Header -->
        <div class="session-header">
            <div class="header-left">
                <a href="dashboard.html" class="back-btn">
                    <i class="fas fa-arrow-left"></i>
                    Back
                </a>
            </div>
            <div class="header-center">
                <h1 class="session-title">Live Session</h1>
            </div>
            <div class="header-right">
                <div class="session-status">
                    <div class="status-dot"></div>
                    LIVE
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading session...</p>
        </div>

        <!-- Session Info -->
        <div id="sessionInfo" class="session-info" style="display: none;">
            <h3>Session Overview</h3>
            <div class="session-stats">
                <div class="session-stat">
                    <span class="session-stat-value" id="totalPlayers">0</span>
                    <span class="session-stat-label">Total Players</span>
                </div>
                <div class="session-stat">
                    <span class="session-stat-value" id="totalGames">0</span>
                    <span class="session-stat-label">Games Played</span>
                </div>
                <div class="session-stat">
                    <span class="session-stat-value" id="sessionDuration">0m</span>
                    <span class="session-stat-label">Duration</span>
                </div>
                <div class="session-stat">
                    <span class="session-stat-value" id="activeTeams">0</span>
                    <span class="session-stat-label">Active Teams</span>
                </div>
            </div>
        </div>

        <!-- Teams Grid -->
        <div id="teamsGrid" class="teams-grid" style="display: none;">
            <!-- Teams will be populated here -->
        </div>

        <!-- Session Actions -->
        <div id="sessionActions" class="session-actions" style="display: none;">
            <button id="endSessionBtn" class="action-btn end-session-btn">
                <i class="fas fa-flag-checkered"></i>
                End Session
            </button>
            <button id="emergencyDeleteBtn" class="action-btn emergency-delete-btn">
                <i class="fas fa-exclamation-triangle"></i>
                Emergency Delete
            </button>
        </div>

        <!-- MVP Selector Modal -->
        <div id="mvpSelector" class="mvp-selector">
            <div class="mvp-content">
                <h3>🏆 Select MVP</h3>
                <p class="mvp-subtitle">Choose the Most Valuable Player from this session</p>
                <div id="mvpPlayers" class="mvp-players">
                    <!-- Players will be populated here -->
                </div>
                <div class="mvp-actions">
                    <button id="selectMvpBtn" class="btn-primary" disabled>
                        <i class="fas fa-trophy"></i> Select MVP
                    </button>
                    <button id="cancelMvpBtn" class="btn-secondary">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBoFoGuzuZHVys-bF02P1mrg6-NbjQj8pY",
            authDomain: "niterun-sports-app.firebaseapp.com",
            projectId: "niterun-sports-app",
            storageBucket: "niterun-sports-app.firebasestorage.app",
            messagingSenderId: "320354701270",
            appId: "1:320354701270:web:53302cfe9a63112e95de77",
            measurementId: "G-VXLNF0KB61"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentSession = null;
        let selectedMvpPlayer = null;

        // Initialize the session tracker
        document.addEventListener('DOMContentLoaded', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('sessionId');
            
            if (sessionId) {
                loadSession(sessionId);
            } else {
                // Show session selection interface
                await showSessionSelection();
            }

            setupEventListeners();
        });

        // Show session selection interface
        async function showSessionSelection() {
            try {
                const user = auth.currentUser;
                if (!user) {
                    showError('Please log in to view sessions');
                    return;
                }

                // Get user's sessions
                const sessionsQuery = await db.collection('sessions')
                    .where('admin', '==', user.uid)
                    .orderBy('createdAt', 'desc')
                    .limit(10)
                    .get();

                const sessions = [];
                sessionsQuery.forEach(doc => {
                    const data = doc.data();
                    sessions.push({
                        id: doc.id,
                        ...data,
                        createdAt: data.createdAt?.toDate() || new Date()
                    });
                });

                if (sessions.length === 0) {
                    showError('No sessions found. Create a session from the team generator.');
                    return;
                }

                // Show session selection
                const loadingState = document.getElementById('loadingState');
                loadingState.innerHTML = `
                    <div style="text-align: center; color: var(--white);">
                        <h2 style="margin-bottom: 2rem; font-family: 'SK Glypher Trial', 'Poppins', sans-serif;">Select a Session</h2>
                        <div style="display: grid; gap: 1rem; max-width: 500px; margin: 0 auto;">
                            ${sessions.map(session => {
                                const teamNames = session.teams?.map(team => team.name).join(' vs ') || 'Session';
                                const statusColor = session.status === 'live' ? '#4CAF50' : session.status === 'completed' ? '#2196F3' : '#FF9800';
                                const statusText = session.status === 'live' ? 'LIVE' : session.status === 'completed' ? 'COMPLETED' : 'PENDING';
                                
                                return `
                                    <div class="session-option" onclick="loadSession('${session.id}')" 
                                         style="background: var(--cream); padding: 1.5rem; border-radius: 8px; cursor: pointer; 
                                                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); transition: transform 0.3s ease;"
                                         onmouseover="this.style.transform='scale(1.02)'" 
                                         onmouseout="this.style.transform='scale(1)'">
                                        <h3 style="color: var(--primary-color); margin: 0 0 0.5rem 0; font-family: 'SK Glypher Trial', 'Poppins', sans-serif;">
                                            ${teamNames}
                                        </h3>
                                        <p style="color: #666; margin: 0; font-size: 0.9rem;">
                                            <span style="color: ${statusColor}; font-weight: 600;">${statusText}</span> • 
                                            ${new Date(session.createdAt).toLocaleDateString()}
                                        </p>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div style="margin-top: 2rem;">
                            <a href="team-generator.html" class="back-btn" style="display: inline-block;">
                                <i class="fas fa-plus"></i>
                                Create New Session
                            </a>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading sessions:', error);
                showError('Error loading sessions');
            }
        }

        // Load session data from Firestore
        async function loadSession(sessionId) {
            try {
                const doc = await db.collection('sessions').doc(sessionId).get();
                
                if (!doc.exists) {
                    showError('Session not found');
                    return;
                }

                currentSession = { id: doc.id, ...doc.data() };
                displaySession();
                
                // Set up real-time listener for session updates
                setupRealtimeListener(sessionId);
                
            } catch (error) {
                console.error('Error loading session:', error);
                showError('Error loading session');
            }
        }

        // Set up real-time listener for session updates
        function setupRealtimeListener(sessionId) {
            db.collection('sessions').doc(sessionId).onSnapshot((doc) => {
                if (doc.exists) {
                    const sessionData = { id: doc.id, ...doc.data() };
                    
                    // Only update if session data has changed
                    if (JSON.stringify(sessionData.teams) !== JSON.stringify(currentSession?.teams)) {
                        currentSession = sessionData;
                        displayTeams(currentSession.teams);
                        console.log('Session updated in real-time');
                    }
                } else {
                    showError('Session no longer exists');
                }
            }, (error) => {
                console.error('Error listening to session updates:', error);
            });
        }

        // Display session data
        function displaySession() {
            if (!currentSession) return;

            const loadingState = document.getElementById('loadingState');
            const sessionInfo = document.getElementById('sessionInfo');
            const teamsGrid = document.getElementById('teamsGrid');
            const sessionActions = document.getElementById('sessionActions');

            loadingState.style.display = 'none';
            sessionInfo.style.display = 'block';
            teamsGrid.style.display = 'grid';
            sessionActions.style.display = 'flex';

            // Update session info
            updateSessionInfo();

            // Display teams
            displayTeams(currentSession.teams);
        }

        // Update session info panel
        function updateSessionInfo() {
            if (!currentSession) return;

            const totalPlayers = currentSession.teams.reduce((total, team) => total + (team.players?.length || 0), 0);
            const totalGames = currentSession.teams.reduce((total, team) => total + (team.wins || 0) + (team.losses || 0) + (team.draws || 0), 0);
            const activeTeams = currentSession.teams.filter(team => (team.players?.length || 0) > 0).length;
            
            // Calculate session duration
            const startTime = currentSession.createdAt?.toDate() || new Date();
            const now = new Date();
            const durationMs = now - startTime;
            const durationMinutes = Math.floor(durationMs / (1000 * 60));
            const durationHours = Math.floor(durationMinutes / 60);
            const durationDisplay = durationHours > 0 ? `${durationHours}h ${durationMinutes % 60}m` : `${durationMinutes}m`;

            document.getElementById('totalPlayers').textContent = totalPlayers;
            document.getElementById('totalGames').textContent = totalGames;
            document.getElementById('sessionDuration').textContent = durationDisplay;
            document.getElementById('activeTeams').textContent = activeTeams;
        }

        // Display teams with W/L/D tracking
        function displayTeams(teams) {
            const teamsGrid = document.getElementById('teamsGrid');
            teamsGrid.innerHTML = '';

            teams.forEach((team, index) => {
                const teamCard = document.createElement('div');
                teamCard.className = 'team-card';
                
                // Check if current user is captain of this team
                const currentUser = auth.currentUser;
                const isCurrentUserCaptain = team.players.some(player => 
                    player.isCaptain && player.uid === currentUser?.uid
                );
                
                teamCard.innerHTML = `
                    <div class="team-header">
                        <h3 class="team-name">${team.name}</h3>
                        <div class="team-stats">
                            <div class="stat-item">
                                <span class="stat-value" id="wins-${index}">${team.wins || 0}</span>
                                <span class="stat-label">Wins</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value" id="losses-${index}">${team.losses || 0}</span>
                                <span class="stat-label">Losses</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value" id="draws-${index}">${team.draws || 0}</span>
                                <span class="stat-label">Draws</span>
                            </div>
                        </div>
                    </div>
                    <div class="team-players">
                        ${team.players.map((player, playerIndex) => `
                            <div class="player-item">
                                <div class="player-info">
                                    <div class="player-number">${String.fromCharCode(65 + playerIndex)}</div>
                                    <div class="player-details">
                                        <div class="player-name">
                                            ${player.name}
                                            ${player.isCaptain ? '<span class="captain-badge">CAPTAIN</span>' : ''}
                                        </div>
                                        <div class="player-meta">${player.level} • ${player.position}</div>
                                    </div>
                                </div>
                                <button class="remove-player-btn" onclick="removePlayer(${index}, ${playerIndex})" title="Remove Player">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    <div class="team-controls">
                        <button class="control-btn win-btn captain-only" 
                                onclick="updateTeamRecord(${index}, 'win')" 
                                ${!isCurrentUserCaptain ? 'disabled' : ''}
                                title="${isCurrentUserCaptain ? 'Record a win for this team' : 'Only team captain can record wins'}">
                            <i class="fas fa-trophy"></i>
                            Win
                        </button>
                        <button class="control-btn loss-btn captain-only" 
                                onclick="updateTeamRecord(${index}, 'loss')" 
                                ${!isCurrentUserCaptain ? 'disabled' : ''}
                                title="${isCurrentUserCaptain ? 'Record a loss for this team' : 'Only team captain can record losses'}">
                            <i class="fas fa-times-circle"></i>
                            Loss
                        </button>
                        <button class="control-btn draw-btn captain-only" 
                                onclick="updateTeamRecord(${index}, 'draw')" 
                                ${!isCurrentUserCaptain ? 'disabled' : ''}
                                title="${isCurrentUserCaptain ? 'Record a draw for this team' : 'Only team captain can record draws'}">
                            <i class="fas fa-equals"></i>
                            Draw
                        </button>
                    </div>
                `;
                
                teamsGrid.appendChild(teamCard);
            });
        }

        // Update team record (W/L/D)
        async function updateTeamRecord(teamIndex, recordType) {
            if (!currentSession) return;

            const team = currentSession.teams[teamIndex];
            const currentUser = auth.currentUser;
            
            // Verify user is captain
            const isCurrentUserCaptain = team.players.some(player => 
                player.isCaptain && player.uid === currentUser?.uid
            );
            
            if (!isCurrentUserCaptain) {
                alert('Only team captains can record wins/losses/draws');
                return;
            }

            try {
                // Update team record
                if (!team.wins) team.wins = 0;
                if (!team.losses) team.losses = 0;
                if (!team.draws) team.draws = 0;

                switch (recordType) {
                    case 'win':
                        team.wins++;
                        break;
                    case 'loss':
                        team.losses++;
                        break;
                    case 'draw':
                        team.draws++;
                        break;
                }

                // Update in Firestore
                await db.collection('sessions').doc(currentSession.id).update({
                    teams: currentSession.teams,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Update UI immediately
                updateTeamStatsDisplay(teamIndex, team);
                updateSessionInfo(); // Update session info panel
                
                // Show confirmation
                const action = recordType === 'win' ? 'win' : recordType === 'loss' ? 'loss' : 'draw';
                showNotification(`${team.name} recorded a ${action}!`, 'success');
                
            } catch (error) {
                console.error('Error updating team record:', error);
                alert('Error updating team record');
            }
        }

        // Update team stats display
        function updateTeamStatsDisplay(teamIndex, team) {
            const winsElement = document.getElementById(`wins-${teamIndex}`);
            const lossesElement = document.getElementById(`losses-${teamIndex}`);
            const drawsElement = document.getElementById(`draws-${teamIndex}`);
            
            if (winsElement) winsElement.textContent = team.wins || 0;
            if (lossesElement) lossesElement.textContent = team.losses || 0;
            if (drawsElement) drawsElement.textContent = team.draws || 0;
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            // Add notification styles
            if (!document.querySelector('#notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    .notification {
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: white;
                        padding: 1rem 1.5rem;
                        border-radius: 8px;
                        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                        z-index: 10001;
                        animation: slideIn 0.3s ease;
                        border-left: 4px solid var(--primary-color);
                    }
                    
                    .notification-success {
                        border-left-color: #4CAF50;
                    }
                    
                    .notification-content {
                        display: flex;
                        align-items: center;
                        gap: 0.75rem;
                        color: var(--primary-color);
                        font-weight: 600;
                    }
                    
                    .notification-content i {
                        color: #4CAF50;
                    }
                    
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Remove player from session
        async function removePlayer(teamIndex, playerIndex) {
            if (!currentSession) return;

            const player = currentSession.teams[teamIndex].players[playerIndex];
            const reason = prompt(`Why is ${player.name} leaving? (injury, emergency, etc.)`);
            
            if (!reason) return;

            if (confirm(`Remove ${player.name} from the session?`)) {
                try {
                    // Add to left players
                    currentSession.leftPlayers.push({
                        name: player.name,
                        team: currentSession.teams[teamIndex].name,
                        leftAt: new Date().toISOString(),
                        reason: reason
                    });

                    // Remove from team
                    currentSession.teams[teamIndex].players.splice(playerIndex, 1);

                    // Update in Firestore
                    await db.collection('sessions').doc(currentSession.id).update({
                        teams: currentSession.teams,
                        leftPlayers: currentSession.leftPlayers
                    });

                    // Refresh display
                    displayTeams(currentSession.teams);
                    
                } catch (error) {
                    console.error('Error removing player:', error);
                    alert('Error removing player');
                }
            }
        }

        // End session and show MVP selector
        function endSession() {
            if (confirm('End this session? This will open MVP selection.')) {
                showMvpSelector();
            }
        }

        // Show MVP selector
        function showMvpSelector() {
            const mvpSelector = document.getElementById('mvpSelector');
            const mvpPlayers = document.getElementById('mvpPlayers');
            
            // Get all players from all teams
            const allPlayers = [];
            currentSession.teams.forEach(team => {
                team.players.forEach(player => {
                    allPlayers.push({
                        ...player,
                        teamName: team.name
                    });
                });
            });

            // Display players with enhanced styling
            mvpPlayers.innerHTML = allPlayers.map(player => `
                <div class="mvp-player" onclick="selectMvpPlayer('${player.name}', '${player.teamName}')">
                    <div class="mvp-player-name">${player.name}</div>
                    <div class="mvp-player-team">${player.teamName}</div>
                    <div class="mvp-player-level">${player.level} • ${player.position}</div>
                </div>
            `).join('');

            mvpSelector.style.display = 'flex';
        }

        // Select MVP player
        function selectMvpPlayer(playerName, teamName) {
            // Remove previous selection
            document.querySelectorAll('.mvp-player').forEach(el => {
                el.classList.remove('selected');
            });

            // Add selection to clicked player
            event.target.closest('.mvp-player').classList.add('selected');
            
            selectedMvpPlayer = { name: playerName, team: teamName };
            
            // Enable select button
            document.getElementById('selectMvpBtn').disabled = false;
        }

        // Confirm MVP selection
        async function confirmMvpSelection() {
            if (!selectedMvpPlayer) return;

            try {
                // Show loading state
                const selectBtn = document.getElementById('selectMvpBtn');
                const originalText = selectBtn.innerHTML;
                selectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Selecting MVP...';
                selectBtn.disabled = true;

                // Update session with MVP
                await db.collection('sessions').doc(currentSession.id).update({
                    mvp: selectedMvpPlayer,
                    status: 'completed',
                    completedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Update user stats (add MVP to user profile)
                const user = auth.currentUser;
                if (user) {
                    await updateUserStats(user.uid, 'mvps', 1);
                }

                // Show success notification
                showNotification(`🏆 MVP selected: ${selectedMvpPlayer.name} from ${selectedMvpPlayer.team}!`, 'success');
                
                // Close modal and redirect to dashboard after a delay
                setTimeout(() => {
                    document.getElementById('mvpSelector').style.display = 'none';
                    window.location.href = 'dashboard.html';
                }, 2000);
                
            } catch (error) {
                console.error('Error selecting MVP:', error);
                alert('Error selecting MVP');
                
                // Reset button
                const selectBtn = document.getElementById('selectMvpBtn');
                selectBtn.innerHTML = '<i class="fas fa-trophy"></i> Select MVP';
                selectBtn.disabled = false;
            }
        }

        // Emergency delete session
        async function emergencyDeleteSession() {
            if (confirm('EMERGENCY DELETE: This will permanently delete the session. Are you sure?')) {
                if (confirm('This action cannot be undone. Type "DELETE" to confirm.')) {
                    const confirmation = prompt('Type "DELETE" to confirm:');
                    if (confirmation === 'DELETE') {
                        try {
                            await db.collection('sessions').doc(currentSession.id).delete();
                            alert('Session deleted');
                            window.location.href = 'dashboard.html';
                        } catch (error) {
                            console.error('Error deleting session:', error);
                            alert('Error deleting session');
                        }
                    }
                }
            }
        }

        // Update user stats
        async function updateUserStats(userId, statType, increment) {
            try {
                const userRef = db.collection('users').doc(userId);
                const doc = await userRef.get();
                
                if (doc.exists) {
                    const currentStats = doc.data().stats || { gamesPlayed: 0, wins: 0, losses: 0, mvps: 0 };
                    currentStats[statType] = (currentStats[statType] || 0) + increment;
                    
                    await userRef.update({ stats: currentStats });
                }
            } catch (error) {
                console.error('Error updating user stats:', error);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('endSessionBtn').addEventListener('click', endSession);
            document.getElementById('emergencyDeleteBtn').addEventListener('click', emergencyDeleteSession);
            document.getElementById('selectMvpBtn').addEventListener('click', confirmMvpSelection);
            document.getElementById('cancelMvpBtn').addEventListener('click', () => {
                document.getElementById('mvpSelector').style.display = 'none';
            });
        }

        // Show error message
        function showError(message) {
            const loadingState = document.getElementById('loadingState');
            loadingState.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                <p>${message}</p>
                <a href="dashboard.html" class="back-btn" style="margin-top: 1rem;">Back to Dashboard</a>
            `;
        }
    </script>
</body>
</html>
